generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT
  CASH
}

enum CategoryKind {
  INCOME
  EXPENSE
  TRANSFER
}

enum TagRuleMatchType {
  CONTAINS
  REGEX
}

enum TagRuleSourceField {
  MERCHANT
  NOTE
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
}

enum BillFrequency {
  MONTHLY
  WEEKLY
  BIWEEKLY
  YEARLY
  ONE_OFF
}

enum SubscriptionFrequency {
  MONTHLY
  YEARLY
}

enum IncomeCadence {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum SavingsRuleType {
  FIXED_MONTHLY
  FIXED_PER_PAYCHECK
  PERCENT_OF_INCOME
}

enum PlanStrategy {
  AVALANCHE
  SNOWBALL
  HYBRID
  CUSTOM
}

enum PlanItemType {
  INCOME
  BILL
  SUBSCRIPTION
  DEBT_MIN
  DEBT_EXTRA
  SAVINGS
  NOTE
}

model User {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  email            String            @unique
  passwordHash     String
  createdAt        DateTime          @default(now())
  accounts         Account[]
  categories       Category[]
  transactions     Transaction[]
  tags             Tag[]
  bills            Bill[]
  subscriptions    Subscription[]
  incomeStreams    IncomeStream[]
  debts            Debt[]
  debtPayments     DebtPayment[]
  savingsGoals     SavingsGoal[]
  mandatorySavings MandatorySavings?
  plans            Plan[]
  plaidItems       PlaidItem[]
  budgets          Budget[]
  tagRules         TagRule[]
  notifications    Notification[]
}

model Account {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  userId         String        @db.ObjectId
  name           String
  type           AccountType
  currency       String
  plaidItemId    String?       @db.ObjectId
  plaidAccountId String?       @unique
  plaidMask      String?
  plaidType      String?
  plaidSubtype   String?
  createdAt      DateTime      @default(now())
  user           User          @relation(fields: [userId], references: [id])
  plaidItem      PlaidItem?    @relation(fields: [plaidItemId], references: [id])
  transactions   Transaction[]

  @@index([userId])
}

model Category {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  userId       String        @db.ObjectId
  name         String
  kind         CategoryKind
  createdAt    DateTime      @default(now())
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  budgets      Budget[]

  @@index([userId])
}

model Transaction {
  id                 String           @id @default(auto()) @map("_id") @db.ObjectId
  userId             String           @db.ObjectId
  accountId          String?          @db.ObjectId
  date               DateTime
  amountDollars      Float
  categoryId         String?          @db.ObjectId
  merchant           String?
  note               String?
  plaidTransactionId String?          @unique
  pending            Boolean          @default(false)
  deletedAt          DateTime?
  createdAt          DateTime         @default(now())
  user               User             @relation(fields: [userId], references: [id])
  account            Account?         @relation(fields: [accountId], references: [id])
  category           Category?        @relation(fields: [categoryId], references: [id])
  transactionTags    TransactionTag[]

  @@index([userId])
  @@index([userId, date])
  @@index([userId, deletedAt])
}

model TagRule {
  id          String             @id @default(auto()) @map("_id") @db.ObjectId
  userId      String             @db.ObjectId
  name        String
  pattern     String
  matchType   TagRuleMatchType
  sourceField TagRuleSourceField
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  user        User               @relation(fields: [userId], references: [id])
  tags        TagRuleTag[]

  @@index([userId])
}

model Budget {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  name          String
  amountDollars Float
  period        BudgetPeriod
  categoryId    String?      @db.ObjectId
  tagId         String?      @db.ObjectId
  createdAt     DateTime     @default(now())
  user          User         @relation(fields: [userId], references: [id])
  category      Category?    @relation(fields: [categoryId], references: [id])
  tag           Tag?         @relation(fields: [tagId], references: [id])

  @@index([userId])
  @@index([categoryId])
  @@index([tagId])
}

model Bill {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  name          String
  amountDollars Float
  dueDayOfMonth Int?
  dueDate       DateTime?
  frequency     BillFrequency
  isEssential   Boolean       @default(true)
  autopay       Boolean       @default(false)
  createdAt     DateTime      @default(now())
  user          User          @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Subscription {
  id                String                @id @default(auto()) @map("_id") @db.ObjectId
  userId            String                @db.ObjectId
  name              String
  amountDollars     Float
  billingDayOfMonth Int
  frequency         SubscriptionFrequency
  cancelable        Boolean
  createdAt         DateTime              @default(now())
  user              User                  @relation(fields: [userId], references: [id])

  @@index([userId])
}

model IncomeStream {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  userId            String            @db.ObjectId
  name              String
  amountDollars     Float
  lastAmountDollars Float?
  cadence           IncomeCadence
  nextPayDate       DateTime
  createdAt         DateTime          @default(now())
  user              User              @relation(fields: [userId], references: [id])
  incomeStreamTags  IncomeStreamTag[]

  @@index([userId])
}

model Debt {
  id                             String        @id @default(auto()) @map("_id") @db.ObjectId
  userId                         String        @db.ObjectId
  name                           String
  principalDollars               Float
  aprBps                         Int
  minPaymentDollars              Float
  estimatedMonthlyPaymentDollars Float?
  dueDayOfMonth                  Int
  estimatedPayoffDate            DateTime?
  createdAt                      DateTime      @default(now())
  user                           User          @relation(fields: [userId], references: [id])
  payments                       DebtPayment[]
  debtTags                       DebtTag[]

  @@index([userId])
}

model SavingsGoal {
  id                    String          @id @default(auto()) @map("_id") @db.ObjectId
  userId                String          @db.ObjectId
  name                  String
  targetDollars         Float
  currentDollars        Float
  ruleType              SavingsRuleType
  ruleValueBpsOrDollars Float
  priority              Int             @default(1)
  createdAt             DateTime        @default(now())
  user                  User            @relation(fields: [userId], references: [id])

  @@index([userId])
}

model MandatorySavings {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @unique @db.ObjectId
  monthsToSave   Int
  targetDollars  Float
  currentDollars Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model Notification {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  userId       String    @db.ObjectId
  type         String
  entityType   String?
  entityId     String?
  milestonePct Int?
  message      String
  createdAt    DateTime  @default(now())
  readAt       DateTime?
  user         User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
}

model Plan {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  name          String
  strategy      PlanStrategy
  horizonMonths Int
  startDate     DateTime
  rulesJson     Json
  summaryJson   Json
  warningsJson  Json
  createdAt     DateTime     @default(now())
  user          User         @relation(fields: [userId], references: [id])
  items         PlanItem[]

  @@index([userId])
}

model PlanItem {
  id                  String       @id @default(auto()) @map("_id") @db.ObjectId
  planId              String       @db.ObjectId
  date                DateTime
  type                PlanItemType
  entityId            String?
  amountDollars       Float
  notes               String?
  balanceSnapshotJson Json?
  createdAt           DateTime     @default(now())
  plan                Plan         @relation(fields: [planId], references: [id])

  @@index([planId])
}

model DebtPayment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  debtId        String   @db.ObjectId
  amountDollars Float
  paymentDate   DateTime
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])
  debt          Debt     @relation(fields: [debtId], references: [id])

  @@index([userId])
  @@index([debtId])
  @@index([debtId, paymentDate])
}

model PlaidItem {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  userId               String    @db.ObjectId
  itemId               String    @unique
  accessTokenEncrypted String
  institutionId        String?
  institutionName      String?
  transactionsCursor   String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id])
  accounts             Account[]

  @@index([userId])
}

model Tag {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  userId           String            @db.ObjectId
  name             String
  createdAt        DateTime          @default(now())
  user             User              @relation(fields: [userId], references: [id])
  transactionTags  TransactionTag[]
  incomeStreamTags IncomeStreamTag[]
  debtTags         DebtTag[]
  budgets          Budget[]
  tagRuleTags      TagRuleTag[]

  @@unique([userId, name])
  @@index([userId])
}

model TagRuleTag {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tagRuleId String   @db.ObjectId
  tagId     String   @db.ObjectId
  createdAt DateTime @default(now())
  tagRule   TagRule  @relation(fields: [tagRuleId], references: [id])
  tag       Tag      @relation(fields: [tagId], references: [id])

  @@unique([tagRuleId, tagId])
  @@index([tagRuleId])
  @@index([tagId])
}

model TransactionTag {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  transactionId String      @db.ObjectId
  tagId         String      @db.ObjectId
  createdAt     DateTime    @default(now())
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  tag           Tag         @relation(fields: [tagId], references: [id])

  @@unique([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
}

model IncomeStreamTag {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  incomeStreamId String       @db.ObjectId
  tagId          String       @db.ObjectId
  createdAt      DateTime     @default(now())
  incomeStream   IncomeStream @relation(fields: [incomeStreamId], references: [id])
  tag            Tag          @relation(fields: [tagId], references: [id])

  @@unique([incomeStreamId, tagId])
  @@index([incomeStreamId])
  @@index([tagId])
}

model DebtTag {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  debtId    String   @db.ObjectId
  tagId     String   @db.ObjectId
  createdAt DateTime @default(now())
  debt      Debt     @relation(fields: [debtId], references: [id])
  tag       Tag      @relation(fields: [tagId], references: [id])

  @@unique([debtId, tagId])
  @@index([debtId])
  @@index([tagId])
}
